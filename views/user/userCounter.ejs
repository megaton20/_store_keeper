


<!-- Topbar -->

<%- include('./partials/navbar') %>




      <!-- top advert placement -->
      <!-- <div class="container">
        <div class="ads-placement card shadow" style=" height: 100px;">
        
        </div>
      </div> -->



<div class="container-fluid">
  <%- include('../partials/messages') %>

  <div class="row mt-4">
    <!-- Categories -->
    <div class="col-lg-2 col-md-4 col-sm-12 mb-3">
      <div class="card-header mb-4">categories</div>
      <div class="card shadow fixed-width-lg">
        <div class="d-block d-md-none">
          <div class="d-flex flex-row flex-nowrap overflow-auto" style="height: 100px; ">
            <!-- Mobile view categories -->
            <% allCategory.forEach(data => { %>
              <button
                data-category="<%= data.Category_name %>"
                class="categoryButton tile card shadow border-1 bg-light text-dark p-4 mr-2"
                style="flex: 0 0 auto;">
                <%= data.Category_name %>
              </button>
            <% }); %>
          </div>
        </div>

        <div class="d-none d-md-block">
          <!-- Desktop view categories -->
          <% allCategory.forEach(data => { %>
            <div class="category">
              <button
                data-category="<%= data.Category_name %>"
                class="categoryButton tile border-0 bg-light text-dark p-3 mb-0"
                style="width: 100%;">
                <%= data.Category_name %>
              </button>
            </div>
          <% }); %>
        </div>
      </div>
    </div>

    
    <!-- Items -->
    <div class="col-lg-10 col-md-8 col-sm-12 mb-3 card">

      <div class="card-header mb-3 p-1">
        <div class="row ">
          <div class="col-lg-6 col-md-8 col-sm-12 "><input id="searchInput" type="text" placeholder="Search in category" class="form-control text-dark"></div>
          <div class="col-lg-6 col-md-8 col-sm-12 " id="itemHeading"></div>
        </div>
      </div>

      <div class="item-container" style="height: 700px; overflow-y: scroll">
        <div class="row" id="itemsContainer">
          <div class="no-items" style="display: flex; justify-content: center; align-items: center; margin: auto; margin-top: 200px;">
            <img style="max-width: 100px; max-height: 100px;" src="/images/fast-food.png" class="card-img-top rounded-4" alt="images">
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Footer -->
<%- include('./partials/footer') %>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>


<script>

 let cart = [];

function updateCartBadge() {
  const cartBadges = document.querySelectorAll('#cart-badge');
  cartBadges.forEach(cartBadge => {
    cartBadge.textContent = cart.length;
  });
}

function updateItemQuantityNumber(item) {
  const itemButtonGroup = document.querySelector(`.btn-group[data-id='${item.id}']`);
  if (itemButtonGroup) {
    const quantityButton = itemButtonGroup.querySelector('.btn-secondary');
    if (quantityButton) {
      quantityButton.textContent = item.quantity;
    }
  }
}

function updateItemButton(itemId) {
  const itemButton = document.querySelector(`.add-to-cart[data-id='${itemId}']`);
  const cartItem = cart.find(cartItem => cartItem.id === itemId);

  if (cartItem) {
    if (itemButton) {
      itemButton.outerHTML = `
        <div class="m-2 btn-group" role="group" data-id="${itemId}">
          <button class="btn btn-danger" onclick="removeFromCart(${itemId})">-</button>
          <button class="btn btn-secondary" disabled>${cartItem.quantity}</button>
          <button class="btn btn-success" onclick="increaseQuantity(${itemId})">+</button>
        </div>
      `;
    }
  } else {
    const parentDiv = document.querySelector(`.btn-group[data-id='${itemId}']`);
    if (parentDiv) {
      parentDiv.outerHTML = `
        <button class="m-2 btn btn-primary add-to-cart" data-id="${itemId}" onclick="handleButtonClick(this)">Add to Cart</button>
      `;
    }
  }
}

function addToCart(item) {
  let existingItem = cart.find(cartItem => cartItem.id === item.id);

  if (existingItem) {
    if (existingItem.quantity < item.max) {
      existingItem.quantity++;
    } else {
      alert(`You can only add up to ${item.max} of this item.`);
      return;
    }
  } else {
    console.log(item);
    item.quantity = 1;
    cart.push(item);
  }

  updateItemQuantityNumber(item);
  updateCartBadge();
  updateItemButton(item.id);

  // Send POST request to server to update cart in database
  $.ajax({
    type: 'POST',
    url: '/updateCart',
    data: JSON.stringify({ cart: cart }),
    contentType: 'application/json',
    success: function(response) {
      console.log('Cart updated successfully:', response);
    },
    error: function(error) {
      console.error('Error updating cart:', error);
    }
  });
}

function increaseQuantity(itemId) {
  let item = cart.find(cartItem => cartItem.id === itemId);
  if (item && item.quantity < item.max) {
    item.quantity++;
    updateItemQuantityNumber(item);
    updateCartBadge();
    updateItemButton(itemId);

    // Update cart in the database
    $.ajax({
      type: 'POST',
      url: '/updateCart',
      data: JSON.stringify({ cart: cart }),
      contentType: 'application/json',
      success: function(response) {
        console.log('Cart updated successfully:', response);
      },
      error: function(error) {
        console.error('Error updating cart:', error);
      }
    });
  } else if (item) {
    alert(`You can only add up to ${item.max} of this item.`);
  }
}

function removeFromCart(itemId) {
  let item = cart.find(cartItem => cartItem.id === itemId);
  if (item) {
    item.quantity--;
    if (item.quantity === 0) {
      cart = cart.filter(cartItem => cartItem.id !== itemId);
    }
    updateItemQuantityNumber(item);
    updateCartBadge();
    updateItemButton(itemId);

    // Update cart in the database
    $.ajax({
      type: 'POST',
      url: '/updateCart',
      data: JSON.stringify({ cart: cart }),
      contentType: 'application/json',
      success: function(response) {
        console.log('Cart updated successfully:', response);
      },
      error: function(error) {
        console.error('Error updating cart:', error);
      }
    });
  }
}

function handleButtonClick(event) {
  const id = parseInt(event.getAttribute("data-id"), 10);
  const name = event.getAttribute("data-name");
  const image = event.getAttribute("data-image");
  const price = parseFloat(event.getAttribute("data-price"));
  const max = parseInt(event.getAttribute("data-max"), 10);

  const item = { id, name, price, max,image };
  // item.uuid  = uuid
  addToCart(item);
}

function fetchItems(category, searchTerm) {
  $.ajax({
    url: `/getItems/${category}?search=${searchTerm}`,
    method: 'GET',
    dataType: 'json',
    success: function(items) {
      populateItems(items);
    },
    error: function(error) {
      console.error('Error fetching items:', error);
    }
  });
}

function populateItems(items) {
  const itemsContainer = document.getElementById('itemsContainer');
  // const itemHeading = document.getElementById('itemHeading');
  itemsContainer.innerHTML = '';

  if (items.length === 0) {
    itemsContainer.innerHTML =   `<div class="no-items" style="display: flex; justify-content: center; align-items: center; margin: auto; margin-top: 200px;">
            <img style="max-width: 100px; max-height: 100px;" src="/images/fast-food.png" class="card-img-top rounded-4" alt="images">
          </div>`
  } else {

    items.forEach(item => {
      const itemElement = document.createElement('div');
      itemElement.classList.add('col-6', 'col-md-4', 'col-lg-2');
      itemElement.innerHTML = `
        <div class="border-1 text-dark text-center mb-4">
          <img style="max-width: 100px; max-height: 100px;" src="/uploads/${item.image}" class="card-img-top rounded-4" alt="${item.image}">
          <p class="card-text text-success m-0">${item.ProductName}</p>
          <p class="card-text m-0"><small>â‚¦${item.UnitPrice}.00</small></p>
          <button class="m-2 btn btn-primary add-to-cart"  data-id="${item.id}" data-name="${item.ProductName}" data-price="${item.UnitPrice}" data-max="${item.total_on_shelf}" data-image="${item.image}" onclick="handleButtonClick(this)">Add to Cart</button>
        </div>
      `;
      itemsContainer.appendChild(itemElement);
      updateItemButton(item.id); // Ensure the button is updated if the item is already in the cart
    });
  }
}

document.querySelectorAll('.categoryButton').forEach(button => {
  button.addEventListener('click', function () {
    document.querySelectorAll('.categoryButton').forEach(btn => btn.classList.remove('active'));
    this.classList.add('active');
    const category = this.getAttribute('data-category');
    fetchItems(category, '');
  });
});

document.getElementById('searchInput').addEventListener('input', function () {
  const searchTerm = this.value;
  const activeCategoryButton = document.querySelector('.categoryButton.active');
  const category = activeCategoryButton ? activeCategoryButton.getAttribute('data-category') : '';
  fetchItems(category, searchTerm);
});

// Initial load
fetchItems('', '');
</script>

